<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ’° Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#28a745">

<style>
body{
    margin:0;
    font-family:'Comic Sans MS', Arial;
    direction:rtl;
    background:#050b18;
    color:white;
}
header{
    background:#28a745;
    padding:20px;
    text-align:center;
    font-size:32px;
    box-shadow:0 0 25px #28a745;
}
.container{
    max-width:1100px;
    margin:auto;
    padding:20px;
}
.card{
    background:#0f1b2e;
    border-radius:20px;
    padding:20px;
    margin-bottom:20px;
    box-shadow:0 0 15px rgba(0,255,150,.4),
               inset 0 0 10px rgba(0,255,150,.2);
}
.total{
    font-size:46px;
    text-align:center;
    padding:20px;
    background:#00ff88;
    color:black;
    border-radius:15px;
    box-shadow:0 0 25px #00ff88;
}
input{
    width:100%;
    padding:14px;
    font-size:20px;
    border-radius:10px;
    border:none;
    margin-bottom:10px;
}
.btn{
    padding:14px;
    font-size:20px;
    border:none;
    border-radius:12px;
    cursor:pointer;
    width:100%;
    margin-top:10px;
}
.scan{ background:#ffc107; color:black; }
.add{ background:#17a2b8; }
.save{ background:#28a745; }
.delete{ background:#dc3545; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }

video{
    width:100%;
    max-height:260px;
    border-radius:15px;
    display:none;
    box-shadow:0 0 20px #00ffff;
}

/* Ø¨Ø­Ø« */
.search{position:relative;}
.suggestions{
    position:absolute;
    background:white;
    width:100%;
    color:black;
    border-radius:10px;
    max-height:200px;
    overflow:auto;
    z-index:1000;
}
.suggestions div{
    padding:12px;
    cursor:pointer;
}
.suggestions div:hover{background:#eee;}

table{
    width:100%;
    border-collapse:collapse;
    background:#0b1628;
    margin-top:15px;
}
th,td{
    border:1px solid #333;
    padding:10px;
    text-align:center;
}
th{background:#28a745;}
td input{
    width:70px;
    font-size:16px;
}
</style>
</head>

<body>
<header>ğŸ’° ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</header>

<div class="container">

<div class="card total" id="total">0</div>

<div class="card">
<button class="btn scan" onclick="toggleScanner()">ğŸ“· Ù‚Ø§Ø±Ø¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
<video id="camera"></video>

<input id="barcode" placeholder="ğŸ“¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯">

<div class="search">
<input id="productSearch" placeholder="ğŸ§¾ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
<div id="suggestions" class="suggestions"></div>
</div>

<input id="price" placeholder="ğŸ’µ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
<input id="qty" type="number" placeholder="ğŸ“¦ Ø§Ù„ÙƒÙ…ÙŠØ©">

<button class="btn add" onclick="addSale()">â• Ø¥Ø¶Ø§ÙØ©</button>
</div>

<div class="card">
<table>
<thead>
<tr>
<th>Ø§Ù„Ù…Ù†ØªØ¬</th>
<th>Ø§Ù„Ø³Ø¹Ø±</th>
<th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
<th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
<th>Ø­Ø°Ù</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<button class="btn save" onclick="saveSales()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ¹</button>
</div>

</div>

<audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
let stock = JSON.parse(localStorage.getItem("stock")) || [];
let sales = [];
let tbody = document.getElementById("tbody");
let totalBox = document.getElementById("total");
let beep = document.getElementById("beep");

let video = document.getElementById("camera");
let scanning=false, stream=null;

/* ================= Ù‚Ø§Ø±Ø¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ================= */
async function toggleScanner(){
    if(scanning){ stopScanner(); return; }

    if(!('BarcodeDetector' in window)){
        alert("Ø§Ù„Ù‡Ø§ØªÙ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ù‚Ø§Ø±Ø¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯");
        return;
    }

    stream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:"environment" }
    });

    video.srcObject = stream;
    video.play();
    video.style.display="block";
    scanning=true;

    const detector = new BarcodeDetector({formats:['ean_13','code_128']});

    async function scanLoop(){
        if(!scanning) return;
        const codes = await detector.detect(video);
        if(codes.length){
            let code = codes[0].rawValue;
            if(code.length>=12){
                document.getElementById("barcode").value = code;
                beep.play();

                let p = stock.find(x=>x.barcode===code);
                if(p){
                    productSearch.value = p.name;
                    price.value = p.sell;
                }
                stopScanner();
                return;
            }
        }
        requestAnimationFrame(scanLoop);
    }
    scanLoop();
}

function stopScanner(){
    scanning=false;
    if(stream) stream.getTracks().forEach(t=>t.stop());
    video.style.display="none";
}

/* ================= Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… ================= */
const productSearch=document.getElementById("productSearch");
const suggestions=document.getElementById("suggestions");
const price=document.getElementById("price");

productSearch.addEventListener("input",()=>{
    suggestions.innerHTML="";
    let v=productSearch.value.toLowerCase();
    if(!v) return;

    stock.forEach(p=>{
        if(p.name.toLowerCase().startsWith(v) && p.qtyLeft>0){
            let d=document.createElement("div");
            d.textContent=p.name+" (Ù…ØªØ¨Ù‚ÙŠ "+p.qtyLeft+")";
            d.onclick=()=>{
                productSearch.value=p.name;
                price.value=p.sell;
                suggestions.innerHTML="";
            };
            suggestions.appendChild(d);
        }
    });
});

/* ================= Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø¨ÙŠØ¹ ================= */
function addSale(){
    let name=productSearch.value;
    let q=Number(qty.value);
    let pr=Number(price.value);
    let p=stock.find(x=>x.name===name);

    if(!p || q<=0 || q>p.qtyLeft){
        alert("Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
        return;
    }

    sales.push({name, price:pr, qty:q});
    render();
    barcode.value=productSearch.value=price.value=qty.value="";
}

/* ================= Ø¹Ø±Ø¶ ================= */
function render(){
    tbody.innerHTML="";
    let t=0;

    sales.forEach((s,i)=>{
        let sum=s.price*s.qty;
        t+=sum;
        tbody.innerHTML+=`
<tr>
<td>${s.name}</td>
<td><input type="number" value="${s.price}" onchange="sales[${i}].price=this.value;render()"></td>
<td><input type="number" value="${s.qty}" onchange="sales[${i}].qty=this.value;render()"></td>
<td>${sum}</td>
<td><button class="delete" onclick="sales.splice(${i},1);render()">âŒ</button></td>
</tr>`;
    });
    totalBox.textContent=t;
}

/* ================= Ø­ÙØ¸ ================= */
function saveSales(){
    if(!sales.length){alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª");return;}

    let history=JSON.parse(localStorage.getItem("salesHistory"))||[];

    sales.forEach(s=>{
        let p=stock.find(x=>x.name===s.name);
        if(p) p.qtyLeft-=s.qty;
        history.push({
            name:s.name,
            price:s.price,
            qty:s.qty,
            date:new Date().toISOString().split("T")[0]
        });
    });

    localStorage.setItem("stock",JSON.stringify(stock));
    localStorage.setItem("salesHistory",JSON.stringify(history));
    alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ¹");
    sales=[];
    render();
}
</script>

</body>
</html>
