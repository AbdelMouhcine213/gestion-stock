<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>واجهة المبيعات</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
    margin:0;
    font-family:Arial, sans-serif;
    direction:rtl;
    background:#f4f6f8;
}

/* العنوان */
header{
    background:#0d6efd;
    color:white;
    padding:25px;
    text-align:center;
    font-size:36px;
    font-weight:bold;
    box-shadow:0 4px 8px rgba(0,0,0,.2);
}

/* صندوق المجموع تحت العنوان جهة اليسار */
.top-total{
    display:flex;
    justify-content:flex-start;
    padding:15px 30px;
}
.total-box{
    width:350px;
    height:200px;
    background:#28a745;
    color:white;
    font-size:60px;
    font-weight:bold;
    border-radius:20px;
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow:0 0 20px rgba(0,0,0,.3);
}

/* منطقة العمل */
.container{
    display:flex;
    gap:30px;
    padding:25px;
    flex-wrap:wrap;
}

/* الإدخالات */
.work{
    flex:1;
    min-width:400px;
}

.inputs{
    display:flex;
    gap:15px;
    margin-bottom:20px;
    flex-wrap:wrap;
}

.inputs input{
    padding:15px;
    font-size:20px;
    border-radius:10px;
    border:1px solid #bbb;
    width:220px;
}

.inputs input[readonly]{
    background:#eee;
}

/* البحث */
.search{
    position:relative;
}

.suggestions{
    position:absolute;
    background:white;
    width:220px;
    border:1px solid #ccc;
    border-radius:10px;
    z-index:1000;
    max-height:180px;
    overflow-y:auto;
    font-size:20px;
}

.suggestions div{
    padding:12px;
    cursor:pointer;
}

.suggestions div:hover{
    background:#f1f1f1;
}

/* الأزرار */
.btn{
    padding:12px 20px;
    font-size:20px;
    border:none;
    border-radius:10px;
    cursor:pointer;
    color:white;
    transition:0.3s;
}
.add{ background:#17a2b8; }
.add:hover{ background:#0b5ed7; }
.save{ background:#28a745; }
.save:hover{ background:#1e7e34; }
.delete{ background:#dc3545; }
.delete:hover{ background:#a71d2a; }

/* الجدول */
table{
    width:100%;
    background:white;
    border-collapse:collapse;
    font-size:20px;
    border-radius:10px;
    overflow:hidden;
    box-shadow:0 4px 8px rgba(0,0,0,.1);
}

th, td{
    padding:12px;
    border:1px solid #ddd;
    text-align:center;
}

th{
    background:#0d6efd;
    color:white;
}
</style>
</head>
<body>

<header>واجهة المبيعات</header>

<!-- المجموع -->
<div class="top-total">
    <div class="total-box" id="total">0</div>
</div>

<div class="container">
<div class="work">

    <div class="inputs">
        <div class="search">
            <input type="text" id="productSearch" placeholder="اسم المنتج" autocomplete="off">
            <div id="suggestions" class="suggestions"></div>
        </div>

        <input type="number" id="price" placeholder="سعر البيع" readonly>
        <input type="number" id="qty" placeholder="الكمية">
        <button class="btn add" onclick="addSale()">إضافة</button>
    </div>

    <table>
        <thead>
        <tr>
            <th>المنتج</th>
            <th>السعر</th>
            <th>الكمية</th>
            <th>المجموع</th>
            <th>حذف</th>
        </tr>
        </thead>
        <tbody id="tbody"></tbody>
    </table>

    <br>
    <button class="btn save" onclick="saveSale()">حفظ البيع</button>
</div>
</div>

<script>
/* تحميل بيانات المخزون */
let stock = JSON.parse(localStorage.getItem("stock")) || [];
let sales = [];
const tbody = document.getElementById("tbody");

/* الإكمال التلقائي */
const productInput = document.getElementById("productSearch");
const suggestions = document.getElementById("suggestions");
const priceInput = document.getElementById("price");

productInput.addEventListener("input", function(){
    let value = this.value.trim().toLowerCase();
    suggestions.innerHTML = "";
    if(!value) return;

    stock.forEach(p=>{
        if(p.name.toLowerCase().startsWith(value) && p.qtyLeft > 0){
            let div = document.createElement("div");
            div.textContent = p.name; // الاسم فقط

            div.onclick = ()=>{
                productInput.value = p.name;
                priceInput.value = p.sell;
                suggestions.innerHTML="";
            };
            suggestions.appendChild(div);
        }
    });
});

/* إضافة المنتج */
function addSale(){
    let name = productInput.value.trim();
    let q = Number(qty.value);
    let product = stock.find(p=>p.name===name);

    if(!product || q<=0){
        alert("بيانات غير صحيحة");
        return;
    }
    if(q > product.qtyLeft){
        alert("الكمية غير متوفرة");
        return;
    }

    let existing = sales.find(s=>s.name===name);
    if(existing){
        existing.qty += q;
    }else{
        sales.push({name, price:product.sell, qty:q});
    }

    render();
    productInput.value="";
    priceInput.value="";
    qty.value="";
}

/* عرض + تعديل + حذف */
function render(){
    tbody.innerHTML="";
    let total=0;

    sales.forEach((s,i)=>{
        let sum = s.price * s.qty;
        total += sum;

        let tr=document.createElement("tr");
        tr.innerHTML=`
<td>${s.name}</td>
<td><input type="number" value="${s.price}" onchange="updatePrice(${i},this.value)"></td>
<td><input type="number" value="${s.qty}" onchange="updateQty(${i},this.value)"></td>
<td>${sum}</td>
<td><button class="btn delete" onclick="del(${i})">❌</button></td>
        `;
        tbody.appendChild(tr);
    });

    document.getElementById("total").textContent = total;
}

function updatePrice(i,v){
    sales[i].price = Number(v);
    render();
}

function updateQty(i,v){
    let product = stock.find(p=>p.name===sales[i].name);
    v = Number(v);
    if(v<=0 || v>product.qtyLeft){
        alert("كمية غير صحيحة");
        render();
        return;
    }
    sales[i].qty = v;
    render();
}

function del(i){
    sales.splice(i,1);
    render();
}

/* حفظ البيع وخصم المخزون */
function saveSale(){
    if(!sales.length){
        alert("لا توجد مبيعات");
        return;
    }

    sales.forEach(s=>{
        let p = stock.find(x=>x.name===s.name);
        if(p) p.qtyLeft -= s.qty;
    });
    localStorage.setItem("stock", JSON.stringify(stock));

    let history = JSON.parse(localStorage.getItem("salesHistory")) || [];
    sales.forEach(s=>{
        history.push({
            name:s.name,
            price:s.price,
            qty:s.qty,
            date:new Date().toISOString().split("T")[0]
        });
    });
    localStorage.setItem("salesHistory", JSON.stringify(history));

    alert("تم حفظ البيع بنجاح ✅");
    sales=[];
    render();
}
</script>

</body>
</html>
