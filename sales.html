<script>
const SHEET_URL = "https://script.google.com/macros/s/YOUR_WEB_APP_ID/exec";

let stock=[], cart=[];

/* ===== Ù„ØºØ§Øª ===== */
const words={
ar:{title:"ğŸ’³ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª",items:"Ø§Ù„Ø¹Ù†Ø§ØµØ±",p:"Ø§Ù„Ù…Ù†ØªØ¬",q:"Ø§Ù„ÙƒÙ…ÙŠØ©",pr:"Ø§Ù„Ø³Ø¹Ø±",t:"Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹",tot:"Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ"},
fr:{title:"ğŸ’³ Ventes",items:"Articles",p:"Produit",q:"QtÃ©",pr:"Prix",t:"Total",tot:"Total gÃ©nÃ©ral"},
en:{title:"ğŸ’³ Sales",items:"Items",p:"Product",q:"Qty",pr:"Price",t:"Total",tot:"Grand Total"}
};

function setLang(l){
    document.body.dir = l==="ar"?"rtl":"ltr";
    title.textContent=words[l].title;
    itemsLabel.textContent=words[l].items;
    p.textContent=words[l].p;
    q.textContent=words[l].q;
    pr.textContent=words[l].pr;
    t.textContent=words[l].t;
    totalLabel.textContent=words[l].tot;
}

/* ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ===== */
async function loadStock(){
    const res = await fetch(SHEET_URL+"?action=getStock");
    stock = await res.json();
    renderCategories();
    if(currentCat) show(currentCat);
}
loadStock();

/* ===== ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„ØªØµÙ†ÙŠÙ ===== */
function editCategory(catName){
    let newName = prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„ØªØµÙ†ÙŠÙ", catName);
    if(newName){
        fetch(SHEET_URL+"?action=editCategory&old="+encodeURIComponent(catName)+"&new="+encodeURIComponent(newName));
        loadStock();
    }
}

/* ===== Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ===== */
let currentCat=null;
function renderCategories(){
    categories.innerHTML="";
    const cats=[...new Set(stock.map(p=>p.category))];
    cats.forEach(c=>{
        let d=document.createElement("div");
        d.className="cat";
        d.textContent=c;
        d.onclick=()=>{ currentCat=c; show(c); };
        d.oncontextmenu=e=>{ e.preventDefault(); editCategory(c); };
        categories.appendChild(d);
    });
}

/* ===== Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ===== */
function show(cat){
    products.innerHTML="";
    stock.filter(p=>p.category===cat && p.qtyLeft>0)
    .forEach(p=>{
        let d=document.createElement("div");
        d.className="product";
        d.innerHTML=`
            <img src="${p.image}">
            <span>${p.name}</span>
            <b>${p.sell} Ø¯Ø¬</b>
            <div class="stockLabel">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${p.qtyLeft}</div>
        `;
        d.onclick=()=>add(p);
        products.appendChild(d);
    });
}

/* ===== Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø© ===== */
function add(p){
    if(p.qtyLeft<=0){ alert("ğŸš« Ù†ÙØ¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†"); return; }

    let item = cart.find(i=>i.name===p.name);
    if(item){
        item.qty++;
    }else{
        cart.push({name:p.name,price:p.sell,qty:1});
    }
    p.qtyLeft--;
    render();
    show(currentCat);
}

/* ===== Ø±Ø³Ù… Ø§Ù„Ø³Ù„Ø© ===== */
function render(){
    cart.innerHTML="";
    let sum=0;

    cart.forEach((i,n)=>{
        let p = stock.find(x=>x.name===i.name);
        let tot=i.qty*i.price;
        sum+=tot;

        let tr=document.createElement("tr");
        tr.innerHTML=`
            <td>${i.name}<br><small>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${p.qtyLeft}</small></td>
            <td>
                <input type="number" min="1" value="${i.qty}"
                onchange="updateQty(${n},this.value)">
            </td>
            <td>${i.price}</td>
            <td>${tot}</td>
            <td><button class="del" onclick="removeItem(${n})">âœ–</button></td>
        `;
        document.getElementById("cart").appendChild(tr);
    });
    total.textContent=sum+" Ø¯Ø¬";
}

/* ===== ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ© ===== */
function updateQty(i,newQty){
    let item=cart[i];
    let p=stock.find(x=>x.name===item.name);
    newQty=Number(newQty);

    if(newQty<1) newQty=1;

    let diff=newQty-item.qty;
    if(diff>0 && p.qtyLeft<diff){
        alert("ğŸš« ÙƒÙ…ÙŠØ© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©");
        return;
    }
    item.qty=newQty;
    p.qtyLeft-=diff;
    render();
    show(currentCat);
}

/* ===== Ø­Ø°Ù Ø¹Ù†ØµØ± ===== */
function removeItem(i){
    let item=cart[i];
    let p=stock.find(x=>x.name===item.name);
    p.qtyLeft+=item.qty;
    cart.splice(i,1);
    render();
    show(currentCat);
}

/* ===== ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨ÙŠØ¹ ===== */
async function confirmSale(){
    if(cart.length===0){ alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©"); return; }

    const res = await fetch(SHEET_URL,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({action:"confirmSale",cart})
    });
    const data=await res.json();

    if(data.success){
        alert("âœ… ØªÙ… Ø§Ù„Ø¨ÙŠØ¹");
        cart=[];
        loadStock();
        render();
    }else alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸");
}

/* ===== ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ø³Ù„Ø© ===== */
cartName.ondblclick=()=>{
    let n=prompt("Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø³Ù„Ø©",cartName.value);
    if(n) cartName.value=n;
};

setLang("ar");
</script>
