<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>المبيعات</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#28a745">
<style>
body{
    margin:0;
    font-family:Arial;
    direction:rtl;
    background:#f4f6f8;
}
header{
    background:#0d6efd;
    color:white;
    padding:20px;
    text-align:center;
    font-size:32px;
    font-weight:bold;
}
.top-total{
    display:flex;
    justify-content:flex-start;
    padding:15px 30px 0 30px;
}
.total-box{
    width:320px;
    height:200px;
    background:#28a745;
    color:white;
    font-size:52px;
    font-weight:bold;
    border-radius:20px;
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow:0 0 15px rgba(0,0,0,.3);
}
.container{
    display:flex;
    gap:30px;
    padding:25px;
    flex-direction:column;
}
.inputs{
    display:flex;
    gap:15px;
    margin-bottom:20px;
}
.inputs input{
    padding:18px;
    font-size:22px;
    border-radius:10px;
    border:1px solid #bbb;
    width:230px;
}
.inputs input[readonly]{ background:#eee; }

.search{ position:relative; }
.suggestions{
    position:absolute;
    background:white;
    width:230px;
    border:1px solid #ccc;
    border-radius:10px;
    z-index:1000;
}
.suggestions div{
    padding:14px;
    font-size:20px;
    cursor:pointer;
}
.suggestions div:hover{ background:#f1f1f1; }

.btn{
    padding:18px 26px;
    font-size:22px;
    border:none;
    border-radius:10px;
    cursor:pointer;
    color:white;
}
.add{ background:#17a2b8; }
.save{ background:#28a745; }
.delete{ background:#dc3545; }

table{
    width:100%;
    background:white;
    border-collapse:collapse;
    font-size:20px;
}
th, td{
    padding:14px;
    border:1px solid #ddd;
    text-align:center;
}
th{ background:#0d6efd; color:white; }

/* ===== POS ===== */
.group-btn{
    padding:14px 22px;
    font-size:18px;
    border:none;
    border-radius:12px;
    background:#0d6efd;
    color:white;
    cursor:pointer;
}
.group-btn:hover{ opacity:.85; }

.product-card{
    background:white;
    border-radius:15px;
    padding:10px;
    text-align:center;
    cursor:pointer;
    box-shadow:0 0 8px rgba(0,0,0,.15);
}
.product-card img{
    width:100%;
    height:110px;
    object-fit:cover;
    border-radius:10px;
}
.product-card .name{
    margin-top:8px;
    font-size:16px;
    font-weight:bold;
}
.product-card .price{
    font-size:14px;
    color:#28a745;
}
.product-card .stock{
    font-size:14px;
    color:#ff4444;
    margin-top:4px;
}
</style>
</head>

<body>

<header>واجهة المبيعات</header>

<div class="top-total">
    <div class="total-box" id="total">0</div>
</div>

<!-- ===== POS AREA ===== -->
<div style="padding:20px 25px;">
    <div id="groups" style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px;"></div>
    <div id="products" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:15px;"></div>
</div>

<div class="container">

<div class="inputs">
    <div class="search">
        <input type="text" id="productSearch" placeholder="اسم المنتج" autocomplete="off">
        <div id="suggestions" class="suggestions"></div>
    </div>
    <input type="number" id="price" placeholder="سعر البيع" readonly>
    <input type="number" id="qty" placeholder="الكمية">
    <button class="btn add" onclick="addSale()">إضافة</button>
</div>

<table>
<thead>
<tr>
    <th>المنتج</th>
    <th>السعر</th>
    <th>الكمية المباعة</th>
    <th>المجموع</th>
    <th>حذف</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<button class="btn save" onclick="saveSale()">حفظ البيع</button>

</div>

<script>
let stock = JSON.parse(localStorage.getItem("stock")) || [];
let sales = [];
const tbody = document.getElementById("tbody");

const productInput = document.getElementById("productSearch");
const suggestions = document.getElementById("suggestions");
const priceInput = document.getElementById("price");

/* البحث النصي */
productInput.addEventListener("input", function(){
    let value = this.value.trim().toLowerCase();
    suggestions.innerHTML = "";
    if(!value) return;

    stock.forEach(p=>{
        if(p.name.toLowerCase().startsWith(value) && p.qtyLeft > 0){
            let div = document.createElement("div");
            div.textContent = p.name;
            div.onclick = ()=>{
                productInput.value = p.name;
                priceInput.value = p.sell;
                suggestions.innerHTML="";
            };
            suggestions.appendChild(div);
        }
    });
});

/* إضافة للبيع */
function addSale(){
    let name = productInput.value;
    let q = Number(document.getElementById("qty").value);
    let product = stock.find(p=>p.name===name);

    if(!product || q<=0){ alert("بيانات غير صحيحة"); return; }
    if(q > product.qtyLeft){ alert("الكمية غير متوفرة"); return; }

    let existing = sales.find(s=>s.name===name);
    if(existing){ existing.qty += q; }
    else{ sales.push({name, price:product.sell, qty:q}); }

    render();
    productInput.value="";
    priceInput.value="";
    document.getElementById("qty").value="";
}

function render(){
    tbody.innerHTML="";
    let total=0;

    sales.forEach((s,i)=>{
        let sum = s.price * s.qty;
        total += sum;

        let tr=document.createElement("tr");
        tr.innerHTML=`
<td>${s.name}</td>
<td><input type="number" value="${s.price}" onchange="updatePrice(${i},this.value)"></td>
<td><input type="number" value="${s.qty}" onchange="updateQty(${i},this.value)"></td>
<td>${sum}</td>
<td><button class="btn delete" onclick="del(${i})">❌</button></td>`;
        tbody.appendChild(tr);
    });

    document.getElementById("total").textContent = total;
}

function updatePrice(i,v){ sales[i].price = Number(v); render(); }
function updateQty(i,v){
    let product = stock.find(p=>p.name===sales[i].name);
    v = Number(v);
    if(v<=0 || v>product.qtyLeft){ alert("كمية غير صحيحة"); render(); return; }
    sales[i].qty = v; render();
}
function del(i){ sales.splice(i,1); render(); }

/* حفظ البيع مع سعر الشراء */
function saveSale(){
    if(!sales.length){ alert("لا توجد مبيعات"); return; }

    sales.forEach(s=>{
        let p = stock.find(x=>x.name===s.name);
        if(p) p.qtyLeft -= s.qty;
    });
    localStorage.setItem("stock", JSON.stringify(stock));

    let history = JSON.parse(localStorage.getItem("salesHistory")) || [];
    sales.forEach(s=>{
        let product = stock.find(p => p.name === s.name);
        history.push({
            name: s.name,
            price: s.price,
            qty: s.qty,         // الكمية المباعة
            buy: product.buy,   // سعر الشراء للحساب فقط
            date: new Date().toISOString().split("T")[0]
        });
    });
    localStorage.setItem("salesHistory", JSON.stringify(history));

    alert("تم حفظ البيع بنجاح ✅");
    sales=[];
    render();
}

/* ===== POS LOGIC ===== */
const groupsDiv = document.getElementById("groups");
const productsDiv = document.getElementById("products");

function loadGroups(){
    let groups = [...new Set(stock.map(p=>p.group).filter(g=>g))];
    groupsDiv.innerHTML="";
    groups.forEach(g=>{
        let btn=document.createElement("button");
        btn.className="group-btn";
        btn.textContent=g;
        btn.onclick=()=>loadProducts(g);
        groupsDiv.appendChild(btn);
    });
}

function loadProducts(group){
    productsDiv.innerHTML="";
    stock.filter(p=>p.group===group && p.qtyLeft>0).forEach(p=>{
        let card=document.createElement("div");
        card.className="product-card";
        card.innerHTML=`
            ${p.img ? `<img src="${p.img}">` : ""}
            <div class="name">${p.name}</div>
            <div class="price">${p.sell}</div>
            <div class="stock">المتبقي: ${p.qtyLeft}</div>`;
        card.onclick=()=>{
            productInput.value = p.name;
            priceInput.value = p.qtyLeft; // وضع الكمية المتبقية بدل سعر البيع
            document.getElementById("qty").value = 1;
            addSale();
        };
        productsDiv.appendChild(card);
    });
}

loadGroups();
</script>

</body>
</html>
