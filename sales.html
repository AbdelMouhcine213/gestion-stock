<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POS</title>

<style>
*{box-sizing:border-box}
body{
    margin:0;
    font-family:Arial;
    direction:rtl;
    background:linear-gradient(160deg,#050b18,#0b2a52);
    color:white;
}
header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:15px;
    background:linear-gradient(90deg,#198754,#20c997);
    font-size:26px;
    font-weight:bold;
}
select{padding:6px;border-radius:8px;border:none;font-size:16px;}

#categories{
    display:flex;
    gap:10px;
    padding:10px;
    overflow-x:auto;
}
.cat{
    background:#0dcaf0;
    color:black;
    padding:10px 18px;
    border-radius:20px;
    font-weight:bold;
    cursor:pointer;
    white-space:nowrap;
}
.cat:hover{background:#66e3ff}

#products{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
    gap:12px;
    padding:12px;
}
.product{
    background:white;
    color:black;
    border-radius:16px;
    padding:8px;
    text-align:center;
    cursor:pointer;
    box-shadow:0 0 15px rgba(0,0,0,.3);
    position:relative;
}
.product img{
    width:100%;
    height:120px;
    object-fit:contain;
}
.product span,.product b{display:block;}

.stockLabel{
    position:absolute;
    top:8px;
    right:8px;
    background:rgba(0,0,0,0.7);
    color:#00ff88;
    padding:2px 6px;
    border-radius:6px;
    font-size:14px;
    font-weight:bold;
}

#cartBox{
    background:#081a33;
    margin:10px;
    border-radius:16px;
    padding:10px;
    box-shadow:0 0 15px rgba(0,255,150,.4);
}
#cartTitle{
    display:flex;
    justify-content:space-between;
    align-items:center;
}
#cartTitle input{
    font-size:18px;
    font-weight:bold;
    border-radius:8px;
    border:none;
    padding:6px;
}

table{
    width:100%;
    border-collapse:collapse;
    margin-top:8px;
}
th,td{
    border-bottom:1px solid #444;
    padding:6px;
    text-align:center;
}
th{background:#0dcaf0;color:black}

button{
    padding:6px 10px;
    border:none;
    border-radius:6px;
    cursor:pointer;
}
.del{background:#dc3545;color:white}

#totalBox{
    margin-top:10px;
    background:black;
    border-radius:16px;
    padding:15px;
    text-align:center;
    box-shadow:0 0 30px rgba(0,255,0,.7);
}
#totalBox span{font-size:20px;}
#total{
    font-size:42px;
    color:#00ff88;
    font-weight:bold;
}

.btn.confirm{
    margin-top:10px;
    padding:10px 20px;
    font-size:18px;
    background:linear-gradient(45deg,#28a745,#20c997);
    color:white;
    border-radius:12px;
    cursor:pointer;
    border:none;
}
</style>
</head>

<body>

<header>
    <span id="title">ğŸ’³ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span>
    <select onchange="setLang(this.value)">
        <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
        <option value="fr">FranÃ§ais</option>
        <option value="en">English</option>
    </select>
</header>

<div id="categories"></div>
<div id="products"></div>

<div id="cartBox">
    <div id="cartTitle">
        <input id="cartName" value="ğŸ›’ Ø³Ù„Ø© Ø§Ù„Ø´Ø±Ø§Ø¡">
        <span id="itemsLabel">Ø§Ù„Ø¹Ù†Ø§ØµØ±</span>
    </div>

    <table>
        <thead>
            <tr>
                <th id="p">Ø§Ù„Ù…Ù†ØªØ¬</th>
                <th id="q">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                <th id="pr">Ø§Ù„Ø³Ø¹Ø±</th>
                <th id="t">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
                <th>âœ–</th>
            </tr>
        </thead>
        <tbody id="cartBody"></tbody>
    </table>

    <div id="totalBox">
        <span id="totalLabel">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ</span>
        <div id="total">0</div>
    </div>

    <button onclick="confirmSale()" class="btn confirm">âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨ÙŠØ¹</button>
</div>

<script>
const SHEET_URL="https://script.google.com/macros/s/YOUR_WEB_APP_ID/exec";

let stock=[];
let cart=[];           // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ù„Ø©
let currentCat=null;
const cartBody=document.getElementById("cartBody");

/* ===== Ù„ØºØ§Øª ===== */
const words={
ar:{title:"ğŸ’³ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª",items:"Ø§Ù„Ø¹Ù†Ø§ØµØ±",p:"Ø§Ù„Ù…Ù†ØªØ¬",q:"Ø§Ù„ÙƒÙ…ÙŠØ©",pr:"Ø§Ù„Ø³Ø¹Ø±",t:"Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹",tot:"Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ"},
fr:{title:"ğŸ’³ Ventes",items:"Articles",p:"Produit",q:"QtÃ©",pr:"Prix",t:"Total",tot:"Total gÃ©nÃ©ral"},
en:{title:"ğŸ’³ Sales",items:"Items",p:"Product",q:"Qty",pr:"Price",t:"Total",tot:"Grand Total"}
};

function setLang(l){
    document.body.dir=l==="ar"?"rtl":"ltr";
    title.textContent=words[l].title;
    itemsLabel.textContent=words[l].items;
    p.textContent=words[l].p;
    q.textContent=words[l].q;
    pr.textContent=words[l].pr;
    t.textContent=words[l].t;
    totalLabel.textContent=words[l].tot;
}

/* ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ===== */
async function loadStock(){
    const r=await fetch(SHEET_URL+"?action=getStock");
    stock=await r.json();
    renderCategories();
    if(currentCat) show(currentCat);
}
loadStock();

/* ===== Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ===== */
function renderCategories(){
    categories.innerHTML="";
    [...new Set(stock.map(p=>p.category))].forEach(c=>{
        let d=document.createElement("div");
        d.className="cat";
        d.textContent=c;
        d.onclick=()=>{currentCat=c;show(c);}
        categories.appendChild(d);
    });
}

/* ===== Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ===== */
function show(cat){
    products.innerHTML="";
    stock.filter(p=>p.category===cat && p.qtyLeft>0)
    .forEach(p=>{
        let d=document.createElement("div");
        d.className="product";
        d.innerHTML=`
            <img src="${p.image}">
            <span>${p.name}</span>
            <b>${p.sell} Ø¯Ø¬</b>
            <div class="stockLabel">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${p.qtyLeft}</div>
        `;
        d.onclick=()=>add(p);
        products.appendChild(d);
    });
}

/* ===== Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø© ===== */
function add(p){
    if(p.qtyLeft<=0)return alert("Ù†ÙØ¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†");
    let i=cart.find(x=>x.name===p.name);
    if(i)i.qty++;
    else cart.push({name:p.name,price:p.sell,qty:1});
    p.qtyLeft--;
    renderCart();
    show(currentCat);
}

/* ===== Ø±Ø³Ù… Ø§Ù„Ø³Ù„Ø© ===== */
function renderCart(){
    cartBody.innerHTML="";
    let sum=0;
    cart.forEach((i,n)=>{
        let p=stock.find(x=>x.name===i.name);
        let tot=i.qty*i.price;
        sum+=tot;
        cartBody.innerHTML+=`
        <tr>
            <td>${i.name}<br><small>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${p.qtyLeft}</small></td>
            <td><input type="number" min="1" value="${i.qty}"
                onchange="updateQty(${n},this.value)"></td>
            <td>${i.price}</td>
            <td>${tot}</td>
            <td><button class="del" onclick="removeItem(${n})">âœ–</button></td>
        </tr>`;
    });
    total.textContent=sum+" Ø¯Ø¬";
}

/* ===== ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ© ===== */
function updateQty(i,v){
    let it=cart[i];
    let p=stock.find(x=>x.name===it.name);
    v=Number(v);
    if(v<1)v=1;
    let diff=v-it.qty;
    if(diff>0 && p.qtyLeft<diff)return alert("ÙƒÙ…ÙŠØ© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©");
    it.qty=v;
    p.qtyLeft-=diff;
    renderCart();
    show(currentCat);
}

/* ===== Ø­Ø°Ù ===== */
function removeItem(i){
    let it=cart[i];
    let p=stock.find(x=>x.name===it.name);
    p.qtyLeft+=it.qty;
    cart.splice(i,1);
    renderCart();
    show(currentCat);
}

/* ===== ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨ÙŠØ¹ ===== */
async function confirmSale(){
    if(cart.length===0)return alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©");
    const r=await fetch(SHEET_URL,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({action:"confirmSale",cart})
    });
    const d=await r.json();
    if(d.success){
        alert("ØªÙ… Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­");
        cart=[];
        loadStock();
        renderCart();
    }else alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸");
}

setLang("ar");
</script>

</body>
</html>
