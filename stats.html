<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
    margin:0;
    font-family:"Comic Sans MS";
    direction:rtl;
    background:linear-gradient(135deg,#1f1c2c,#928dab);
    color:white;
}
header{
    padding:20px;
    text-align:center;
    font-size:32px;
    box-shadow:0 0 20px #ff6bff;
}
.card{
    background:rgba(0,0,0,.4);
    margin:20px;
    padding:25px;
    border-radius:20px;
    box-shadow:0 0 15px #ff6bff;
}
input, select{
    padding:10px;
    font-size:18px;
    border-radius:10px;
    border:none;
    margin-right:10px;
}
button{
    padding:10px 15px;
    font-size:18px;
    border:none;
    border-radius:10px;
    background:#0d6efd;
    color:white;
    cursor:pointer;
    margin-right:5px;
}
table{
    width:100%;
    border-collapse:collapse;
    margin-top:15px;
    background:rgba(255,255,255,0.9);
    color:#000;
}
th, td{
    border:1px solid #ddd;
    padding:10px;
    text-align:center;
}
th{
    background:#0d6efd;
    color:white;
}
td input{
    width:80px;
    text-align:center;
}
</style>
</head>

<body>

<header>ğŸ“ˆ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©</header>

<div class="card">
    <h2>ğŸ“… Ø§Ù„Ø±Ø¨Ø­ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®</h2>
    <div style="margin-bottom:15px;">
        <input type="date" id="dateFilter">
        <select id="periodFilter">
            <option value="day">Ø§Ù„ÙŠÙˆÙ…ÙŠ</option>
            <option value="week">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</option>
            <option value="month">Ø§Ù„Ø´Ù‡Ø±ÙŠ</option>
            <option value="year">Ø§Ù„Ø³Ù†ÙˆÙŠ</option>
        </select>
        <button onclick="calculate()">Ø¨Ø­Ø«</button>
        <button onclick="exportTable()">ØªØµØ¯ÙŠØ± Excel</button>
    </div>
    <div id="summary">
        <p>Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø®Ø§Ù…: <span id="gross">0</span></p>
        <p>Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ØµØ§ÙÙŠ: <span id="net">0</span></p>
    </div>

    <table id="detailsTable">
        <thead>
            <tr>
                <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</th>
                <th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
                <th>Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø®Ø§Ù…</th>
                <th>Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ØµØ§ÙÙŠ</th>
                <th>ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
// ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
function loadSalesHistory(){
    return JSON.parse(localStorage.getItem("salesHistory")) || [];
}
function saveSalesHistory(history){
    localStorage.setItem("salesHistory", JSON.stringify(history));
}

// ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†ØªØ¬
function groupSales(sales){
    const grouped = {};
    sales.forEach(s => {
        if(grouped[s.name]){
            grouped[s.name].qty += s.qty;
            grouped[s.name].totalGross += s.price * s.qty;
            grouped[s.name].totalNet += (s.price - s.buy) * s.qty;
        } else {
            grouped[s.name] = {
                name: s.name,
                qty: s.qty,
                price: s.price,
                totalGross: s.price * s.qty,
                totalNet: (s.price - s.buy) * s.qty,
                indices: [s._index]
            };
        }
    });
    return Object.values(grouped);
}

// Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
function calculate(){
    let history = loadSalesHistory();
    const filterDate = document.getElementById("dateFilter").value;
    const period = document.getElementById("periodFilter").value;
    if(!filterDate){ alert("Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ®"); return; }
    const selectedDate = new Date(filterDate);

    let filtered = [];

    history.forEach((s,index)=>{
        let saleDate = new Date(s.date);
        let match=false;

        if(period==="day"){
            match = saleDate.toDateString() === selectedDate.toDateString();
        } else if(period==="week"){
            let start = new Date(selectedDate);
            start.setDate(start.getDate() - start.getDay());
            let end = new Date(start);
            end.setDate(end.getDate() + 6);
            match = saleDate >= start && saleDate <= end;
        } else if(period==="month"){
            match = saleDate.getFullYear() === selectedDate.getFullYear() &&
                    saleDate.getMonth() === selectedDate.getMonth();
        } else if(period==="year"){
            match = saleDate.getFullYear() === selectedDate.getFullYear();
        }

        if(match){
            let sCopy = {...s, _index:index}; // Ø­ÙØ¸ Ø§Ù„Ù…Ø¤Ø´Ø± Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª/Ø­Ø°Ù
            filtered.push(sCopy);
        }
    });

    // ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†ØªØ¬
    const grouped = groupSales(filtered);

    // Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    const tbody = document.querySelector("#detailsTable tbody");
    tbody.innerHTML="";
    let totalGross=0, totalNet=0;

    grouped.forEach(item=>{
        totalGross += item.totalGross;
        totalNet += item.totalNet;

        let tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${item.name}</td>
            <td><input type="number" value="${item.qty}" onchange="updateQtyGrouped(${item.indices.join(',')}, this.value)"></td>
            <td><input type="number" value="${item.price}" onchange="updatePriceGrouped(${item.indices.join(',')}, this.value)"></td>
            <td>${item.totalGross}</td>
            <td>${item.totalNet}</td>
            <td><button onclick="deleteGrouped(${item.indices.join(',')})">âŒ Ø­Ø°Ù</button></td>
        `;
        tbody.appendChild(tr);
    });

    document.getElementById("gross").textContent = totalGross;
    document.getElementById("net").textContent = totalNet;
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ…ÙŠØ© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©
function updateQtyGrouped(...args){
    const newQty = Number(args.pop());
    if(newQty<=0){ alert("ÙƒÙ…ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©"); return; }
    const indices = args;

    let history = loadSalesHistory();
    indices.forEach(i=>{ history[i].qty = newQty; });
    saveSalesHistory(history);
    calculate();
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø± Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©
function updatePriceGrouped(...args){
    const newPrice = Number(args.pop());
    if(newPrice<=0){ alert("Ø³Ø¹Ø± ØºÙŠØ± ØµØ­ÙŠØ­"); return; }
    const indices = args;

    let history = loadSalesHistory();
    indices.forEach(i=>{ history[i].price = newPrice; });
    saveSalesHistory(history);
    calculate();
}

// Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©
function deleteGrouped(...indices){
    if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù ÙƒÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§ØªØŸ")) return;
    let history = loadSalesHistory();
    // Ø­Ø°Ù Ù…Ù† Ø¢Ø®Ø± Ù„Ø¨Ø¯Ø¡ index Ù„ØªØ¬Ù†Ø¨ Ø§Ù†Ø²Ù„Ø§Ù‚ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
    indices.sort((a,b)=>b-a).forEach(i=>{ history.splice(i,1); });
    saveSalesHistory(history);
    calculate();
}

// ØªØµØ¯ÙŠØ± Ø§Ù„Ø¬Ø¯ÙˆÙ„ Excel
function exportTable(){
    let table = document.getElementById("detailsTable");
    let html = table.outerHTML.replace(/ /g,'%20');
    let url = 'data:application/vnd.ms-excel,' + html;
    let a = document.createElement('a');
    a.href = url;
    a.download = 'sales_statistics.xls';
    a.click();
}
</script>
</body>
</html>
