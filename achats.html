<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ›’ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#17a2b8">

<style>
body{
    margin:0;
    font-family:'Comic Sans MS', Arial;
    direction:rtl;
    background:#050b18;
    color:white;
}
header{
    background:#17a2b8;
    padding:20px;
    text-align:center;
    font-size:30px;
    box-shadow:0 0 25px #17a2b8;
}
.container{
    max-width:1100px;
    margin:auto;
    padding:20px;
}
.card{
    background:#0f1b2e;
    border-radius:20px;
    padding:20px;
    margin-bottom:20px;
    box-shadow:0 0 15px rgba(0,200,255,.4),
               inset 0 0 10px rgba(0,200,255,.2);
}
input,select{
    width:100%;
    padding:14px;
    font-size:18px;
    border-radius:10px;
    border:none;
    margin-bottom:10px;
}
.btn{
    padding:14px;
    font-size:18px;
    border:none;
    border-radius:12px;
    cursor:pointer;
    width:100%;
    margin-top:10px;
}
.scan{ background:#ffc107; color:black; }
.save{ background:#28a745; }

video{
    width:100%;
    max-height:260px;
    border-radius:15px;
    display:none;
    box-shadow:0 0 20px #00ffff;
}
.frame{
    border:3px solid #00ffff;
    border-radius:15px;
    padding:5px;
    margin-bottom:10px;
}

/* Ù„ØºØ§Øª */
.lang{
    display:flex;
    gap:10px;
}
.lang button{
    flex:1;
    background:#333;
    color:white;
}
</style>
</head>

<body>

<header id="title">ğŸ›’ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</header>

<div class="container">

<div class="lang">
<button onclick="setLang('ar')">AR</button>
<button onclick="setLang('fr')">FR</button>
<button onclick="setLang('en')">EN</button>
</div>

<div class="card">
<button class="btn scan" onclick="toggleScanner()" id="scanBtn">ğŸ“· Ù‚Ø§Ø±Ø¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
<button class="btn scan" onclick="switchCamera()">ğŸ”„ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>

<div class="frame">
<video id="camera"></video>
</div>

<input id="barcode" placeholder="ğŸ“¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯">
<input id="name" placeholder="ğŸ§¾ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
<input id="buy" type="number" placeholder="ğŸ’° Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">
<input id="sell" type="number" placeholder="ğŸ’µ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
<input id="qty" type="number" placeholder="ğŸ“¦ Ø§Ù„ÙƒÙ…ÙŠØ©">
<input id="expiry" type="date">

<button class="btn save" onclick="savePurchase()" id="saveBtn">ğŸ’¾ Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</button>
</div>

</div>

<audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
let stock = JSON.parse(localStorage.getItem("stock")) || [];
let video=document.getElementById("camera");
let beep=document.getElementById("beep");
let scanning=false, stream=null;
let facing="environment";

/* ================= Ù„ØºØ§Øª ================= */
const langText={
ar:{
title:"ğŸ›’ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª",
scan:"ğŸ“· Ù‚Ø§Ø±Ø¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯",
save:"ğŸ’¾ Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†"
},
fr:{
title:"ğŸ›’ Achats",
scan:"ğŸ“· Scanner code-barres",
save:"ğŸ’¾ Enregistrer au stock"
},
en:{
title:"ğŸ›’ Purchases",
scan:"ğŸ“· Barcode Scanner",
save:"ğŸ’¾ Save to stock"
}
};

function setLang(l){
document.getElementById("title").textContent=langText[l].title;
document.getElementById("scanBtn").textContent=langText[l].scan;
document.getElementById("saveBtn").textContent=langText[l].save;
}

/* ================= Ù‚Ø§Ø±Ø¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ================= */
async function toggleScanner(){
if(scanning){ stopScanner(); return; }

if(!('BarcodeDetector' in window)){
alert("Barcode ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…");
return;
}

stream=await navigator.mediaDevices.getUserMedia({
video:{
facingMode:facing,
advanced:[{zoom:2}]
}
});

video.srcObject=stream;
video.play();
video.style.display="block";
scanning=true;

const detector=new BarcodeDetector({
formats:['ean_13','code_128','qr_code','ean_8','upc_a']
});

scanLoop(detector);
}

async function scanLoop(detector){
if(!scanning) return;
const codes=await detector.detect(video);
if(codes.length){
let code=codes[0].rawValue;
document.getElementById("barcode").value=code;
beep.play();
stopScanner();
}
requestAnimationFrame(()=>scanLoop(detector));
}

function stopScanner(){
scanning=false;
if(stream) stream.getTracks().forEach(t=>t.stop());
video.style.display="none";
}

function switchCamera(){
facing = facing==="environment" ? "user" : "environment";
if(scanning){
stopScanner();
toggleScanner();
}
}

/* ================= Ø­ÙØ¸ Ø§Ù„Ø´Ø±Ø§Ø¡ ================= */
function savePurchase(){
let item={
barcode:barcode.value,
name:name.value,
buy:Number(buy.value),
sell:Number(sell.value),
qtyOriginal:Number(qty.value),
qtyLeft:Number(qty.value),
expiry:expiry.value,
date:new Date().toISOString().split("T")[0]
};

if(!item.name || !item.qtyOriginal){
alert("Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");
return;
}

stock.push(item);
localStorage.setItem("stock",JSON.stringify(stock));
alert("âœ… ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†");

document.querySelectorAll("input").forEach(i=>i.value="");
}
</script>

</body>
</html>
