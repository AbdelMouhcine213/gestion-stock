<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ›’ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#28a745">

<!-- Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…ÙƒØªØ¨Ø© html5-qrcode -->
<script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>

<style>
body{
    font-family:'Comic Sans MS', Arial;
    direction:rtl;
    background:#050b18;
    color:white;
    margin:0;
}
header{
    background:#28a745;
    padding:20px;
    text-align:center;
    font-size:32px;
    font-weight:bold;
    box-shadow:0 0 25px #28a745;
}
.container{
    padding:20px;
    max-width:1100px;
    margin:auto;
}
.card{
    background:#0f1b2e;
    border-radius:20px;
    padding:20px;
    margin-bottom:20px;
    box-shadow:0 0 15px rgba(0,255,150,.4), inset 0 0 10px rgba(0,255,150,.2);
}
input{
    width:100%;
    padding:12px;
    font-size:18px;
    border-radius:10px;
    border:none;
    margin-bottom:10px;
}
.btn{
    padding:12px;
    font-size:18px;
    border:none;
    border-radius:10px;
    cursor:pointer;
    width:100%;
    margin-top:5px;
}
.scan{background:#ffc107;color:black;}
.add{background:#17a2b8;}
.save{background:#28a745;}
table{
    width:100%;
    border-collapse:collapse;
    margin-top:10px;
    background:#0b1628;
}
th,td{
    border:1px solid #333;
    padding:10px;
    text-align:center;
}
th{background:#28a745;}
.delete{
    background:#dc3545;
    border:none;
    padding:6px 10px;
    border-radius:6px;
    cursor:pointer;
}
</style>
</head>
<body>

<header>ğŸ›’ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</header>

<div class="container">

<!-- Ø¨Ø·Ø§Ù‚Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ù†ØªØ¬ -->
<div class="card">
    <button class="btn scan" onclick="startScanner()">ğŸ“· ÙØªØ­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
    <button class="btn scan" onclick="switchCamera()">ğŸ”„ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
    <div id="qr-reader" style="width:100%; display:none;"></div>

    <input id="barcode" placeholder="ğŸ“¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯">
    <input id="productName" placeholder="ğŸ§¾ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
    <input id="buyPrice" placeholder="ğŸ’µ Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">
    <input id="sellPrice" placeholder="ğŸ’° Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
    <input id="quantity" type="number" placeholder="ğŸ“¦ Ø§Ù„ÙƒÙ…ÙŠØ©">
    <input id="expiryDate" type="date" placeholder="ğŸ“… Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©">

    <button class="btn add" onclick="addPurchase()">â• Ø¥Ø¶Ø§ÙØ©</button>
</div>

<!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª -->
<div class="card">
<table>
<thead>
<tr>
<th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±Ø§Ø¡</th>
<th>Ø§Ù„Ù…Ù†ØªØ¬</th>
<th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
<th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
<th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
<th>Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
<th>Ø­Ø°Ù</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<button class="btn save" onclick="savePurchases()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</button>
</div>

<audio id="beep">
<source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAIlYAAESsAAACABAAZGF0YRAAAAAA//8AAP//AAD//wAA">
</audio>

<script>
let stock = JSON.parse(localStorage.getItem("stock")) || [];
let purchaseList = [];
const tbody = document.getElementById("tbody");
const beep = document.getElementById("beep");

let html5QrCode;
let currentCameraId = null;
let cameraIds = [];

// ================= Ù‚Ø§Ø±Ø¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ =================
async function startScanner(){
    if(!html5QrCode){
        html5QrCode = new Html5Qrcode("qr-reader");
    }
    document.getElementById("qr-reader").style.display="block";

    const devices = await Html5Qrcode.getCameras();
    if(devices && devices.length){
        cameraIds = devices.map(d=>d.id);
        currentCameraId = cameraIds[0];
        scanCamera(currentCameraId);
    } else {
        alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒØ§Ù…ÙŠØ±Ø§ Ù…ØªØ§Ø­Ø©");
    }
}

function scanCamera(cameraId){
    html5QrCode.start(
        cameraId,
        {
            fps:10,
            qrbox:250
        },
        (decodedText, decodedResult)=>{
            // Ø¹Ù†Ø¯ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
            beep.play();
            document.getElementById("barcode").value = decodedText;

            // Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
            let p = stock.find(x=>x.barcode === decodedText);
            if(p){
                document.getElementById("productName").value = p.name;
                document.getElementById("sellPrice").value = p.sell;
            }
            html5QrCode.stop();
            document.getElementById("qr-reader").style.display="none";
        },
        (errorMessage)=>{}
    ).catch(err=>console.log(err));
}

function switchCamera(){
    if(cameraIds.length<2) return;
    currentCameraId = (currentCameraId === cameraIds[0]) ? cameraIds[1] : cameraIds[0];
    scanCamera(currentCameraId);
}

// ================= Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØªØ±ÙŠØ§Øª =================
function addPurchase(){
    let purchaseDate = new Date().toISOString().split("T")[0];
    let productName = document.getElementById("productName").value;
    let buyPrice = Number(document.getElementById("buyPrice").value);
    let sellPrice = Number(document.getElementById("sellPrice").value);
    let quantity = Number(document.getElementById("quantity").value);
    let expiryDate = document.getElementById("expiryDate").value;

    if(!productName || !buyPrice || !sellPrice || !quantity || !expiryDate){
        alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");
        return;
    }

    purchaseList.push({
        purchaseDate,
        productName,
        buyPrice,
        sellPrice,
        quantity,
        expiryDate
    });

    render();
    clearInputs();
}

// ================= Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª =================
function render(){
    tbody.innerHTML="";
    purchaseList.forEach((p,i)=>{
        let tr=document.createElement("tr");
        tr.innerHTML=`
<td>${p.purchaseDate}</td>
<td>${p.productName}</td>
<td>${p.buyPrice}</td>
<td>${p.sellPrice}</td>
<td>${p.quantity}</td>
<td>${p.expiryDate}</td>
<td><button class="delete" onclick="deletePurchase(${i})">âŒ</button></td>
        `;
        tbody.appendChild(tr);
    });
}

function deletePurchase(i){
    purchaseList.splice(i,1);
    render();
}

function clearInputs(){
    document.querySelectorAll("input").forEach(i=>i.value="");
}

// ================= Ø­ÙØ¸ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† =================
function savePurchases(){
    if(!purchaseList.length){ alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙŠØ§Øª"); return; }

    purchaseList.forEach(p=>{
        let existing = stock.find(s=>s.name===p.productName);
        if(existing){
            existing.qtyOriginal += p.quantity;
            existing.qtyLeft += p.quantity;
            existing.buy = p.buyPrice;
            existing.sell = p.sellPrice;
            existing.expiry = p.expiryDate;
        } else {
            stock.push({
                name:p.productName,
                buy:p.buyPrice,
                sell:p.sellPrice,
                qtyOriginal:p.quantity,
                qtyLeft:p.quantity,
                expiry:p.expiryDate
            });
        }
    });

    localStorage.setItem("stock", JSON.stringify(stock));
    alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†");
    purchaseList=[];
    render();
}
</script>

</body>
</html>
