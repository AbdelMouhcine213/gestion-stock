<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ›’ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#28a745">

<!-- Ù…ÙƒØªØ¨Ø© html5-qrcode -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
body{
    font-family:'Comic Sans MS', Arial;
    direction:rtl;
    background:#050b18;
    color:white;
    margin:0;
}
header{
    background:#28a745;
    padding:20px;
    text-align:center;
    font-size:32px;
    font-weight:bold;
    box-shadow:0 0 25px #28a745;
}
.container{
    max-width:1100px;
    margin:auto;
    padding:20px;
}
.card{
    background:#0f1b2e;
    border-radius:20px;
    padding:20px;
    box-shadow:0 0 15px rgba(0,255,150,.4), inset 0 0 10px rgba(0,255,150,.2);
    margin-bottom:20px;
}
input{
    width:100%;
    padding:14px;
    font-size:18px;
    border-radius:10px;
    border:none;
    margin-bottom:10px;
}
button{
    padding:14px;
    font-size:18px;
    border:none;
    border-radius:12px;
    cursor:pointer;
    width:100%;
    margin-top:10px;
}
.add{ background:#17a2b8; }
.save{ background:#28a745; }
.scan{ background:#ffc107; color:black; }

table{
    width:100%;
    border-collapse:collapse;
    margin-top:15px;
    background:#0b1628;
    font-size:16px;
}
th,td{
    border:1px solid #333;
    padding:10px;
    text-align:center;
}
th{background:#28a745;}
.delete{
    background:#dc3545;
    border:none;
    padding:6px 10px;
    border-radius:6px;
    cursor:pointer;
}

/* Ù‚Ø§Ø±Ø¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ */
#reader{
    width:100%;
    max-width:400px;
    margin-bottom:15px;
}
.suggestions{
    position:absolute;
    background:white;
    width:100%;
    border-radius:10px;
    max-height:200px;
    overflow-y:auto;
    color:black;
    z-index:1000;
}
.suggestions div{
    padding:10px;
    cursor:pointer;
}
.suggestions div:hover{
    background:#eee;
}
</style>
</head>
<body>

<header>ğŸ›’ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</header>

<div class="container">

<div class="card">
    <button class="scan" onclick="startScanner()">ğŸ“· Ù‚Ø§Ø±Ø¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
    <button onclick="toggleCamera()">ğŸ”„ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
    <div id="reader" style="display:none;"></div>

    <input id="barcode" placeholder="ğŸ“¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯">
    <div class="search">
        <input id="productName" placeholder="ğŸ§¾ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
        <div id="suggestions" class="suggestions"></div>
    </div>
    <input id="buyPrice" type="number" placeholder="ğŸ’° Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">
    <input id="sellPrice" type="number" placeholder="ğŸ’µ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
    <input id="quantity" type="number" placeholder="ğŸ“¦ Ø§Ù„ÙƒÙ…ÙŠØ©">
    <input id="purchaseDate" type="date" placeholder="ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±Ø§Ø¡">
    <input id="expiryDate" type="date" placeholder="ğŸ“… Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©">

    <button class="add" onclick="addPurchase()">â• Ø¥Ø¶Ø§ÙØ©</button>
</div>

<div class="card">
<table>
<thead>
<tr>
<th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±Ø§Ø¡</th>
<th>Ø§Ù„Ù…Ù†ØªØ¬</th>
<th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
<th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
<th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
<th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
<th>Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
<th>ØªØ¹Ø¯ÙŠÙ„</th>
<th>Ø­Ø°Ù</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<button class="save" onclick="savePurchases()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</button>
</div>

<audio id="beep">
<source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAIlYAAESsAAACABAAZGF0YRAAAAAA//8AAP//AAD//wAA">
</audio>

</div>

<script>
let stock = JSON.parse(localStorage.getItem("stock")) || [];
let purchases = [];
const tbody = document.getElementById("tbody");
const beep = document.getElementById("beep");
let html5QrcodeScanner = null;
let currentCameraId = null;

/* =================== Ù‚Ø§Ø±Ø¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ =================== */
async function startScanner(){
    const cameras = await Html5Qrcode.getCameras();
    if(!cameras.length){ alert("Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ§Ù…ÙŠØ±Ø§ Ù…ØªØ§Ø­Ø©"); return; }
    currentCameraId = currentCameraId || cameras[0].id;

    if(!html5QrcodeScanner) html5QrcodeScanner = new Html5Qrcode("reader");

    document.getElementById("reader").style.display = "block";
    html5QrcodeScanner.start(
        currentCameraId,
        { fps: 10, qrbox: 250 },
        (decodedText) => {
            beep.play();
            document.getElementById("barcode").value = decodedText;
            let p = stock.find(x=>x.barcode===decodedText);
            if(p){
                document.getElementById("productName").value = p.name;
                document.getElementById("buyPrice").value = p.buy;
                document.getElementById("sellPrice").value = p.sell;
            }
            html5QrcodeScanner.stop();
            document.getElementById("reader").style.display = "none";
        },
        (errorMessage) => {}
    );
}

async function toggleCamera(){
    const cameras = await Html5Qrcode.getCameras();
    if(cameras.length < 2) return alert("ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ù…ØªÙˆÙØ±Ø©");
    currentCameraId = currentCameraId === cameras[0].id ? cameras[1].id : cameras[0].id;
    if(html5QrcodeScanner) await html5QrcodeScanner.stop();
    startScanner();
}

/* =================== Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù…Ù†ØªØ¬ =================== */
const productInput = document.getElementById("productName");
const suggestions = document.getElementById("suggestions");
productInput.addEventListener("input", function(){
    let value = this.value.trim().toLowerCase();
    suggestions.innerHTML = "";
    if(!value) return;

    stock.forEach(p=>{
        if(p.name.toLowerCase().startsWith(value) && p.qtyLeft > 0){
            let div = document.createElement("div");
            div.textContent = p.name + " (Ù…ØªØ¨Ù‚ÙŠ: " + p.qtyLeft + ")";
            div.onclick = ()=>{ 
                productInput.value = p.name;
                document.getElementById("sellPrice").value = p.sell;
                suggestions.innerHTML="";
            };
            suggestions.appendChild(div);
        }
    });
});

/* =================== Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª =================== */
function addPurchase(){
    let purchaseDate = document.getElementById("purchaseDate").value;
    let name  = productInput.value;
    let buy   = Number(document.getElementById("buyPrice").value);
    let sell  = Number(document.getElementById("sellPrice").value);
    let qty   = Number(document.getElementById("quantity").value);
    let expiry= document.getElementById("expiryDate").value;
    let barcode = document.getElementById("barcode").value;

    if(!purchaseDate || !name || !buy || !sell || !qty || !expiry){
        alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„"); return;
    }

    purchases.push({purchaseDate,name,buy,sell,qty,expiry,barcode});
    render();
    document.querySelectorAll("#barcode,#productName,#buyPrice,#sellPrice,#quantity,#purchaseDate,#expiryDate").forEach(i=>i.value="");
}

/* =================== Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ =================== */
function render(){
    tbody.innerHTML="";
    purchases.forEach((p,i)=>{
        let tr = document.createElement("tr");
        tr.innerHTML = `
<td>${p.purchaseDate}</td>
<td>${p.name}</td>
<td>${p.buy}</td>
<td>${p.sell}</td>
<td>${p.qty}</td>
<td>${p.buy*p.qty}</td>
<td>${p.expiry}</td>
<td><button class="add" onclick="edit(${i})">âœï¸</button></td>
<td><button class="delete" onclick="del(${i})">âŒ</button></td>
        `;
        tbody.appendChild(tr);
    });
}

function edit(i){
    let p = purchases[i];
    document.getElementById("purchaseDate").value = p.purchaseDate;
    document.getElementById("productName").value = p.name;
    document.getElementById("buyPrice").value = p.buy;
    document.getElementById("sellPrice").value = p.sell;
    document.getElementById("quantity").value = p.qty;
    document.getElementById("expiryDate").value = p.expiry;
    document.getElementById("barcode").value = p.barcode;
    purchases.splice(i,1);
    render();
}

function del(i){ purchases.splice(i,1); render(); }

/* =================== Ø­ÙØ¸ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† =================== */
function savePurchases(){
    if(!purchases.length){ alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙŠØ§Øª"); return; }

    purchases.forEach(p=>{
        let existing = stock.find(s=>s.name===p.name);
        if(existing){
            existing.qtyOriginal += p.qty;
            existing.qtyLeft     += p.qty;
            existing.buy          = p.buy;
            existing.sell         = p.sell;
            existing.date         = p.purchaseDate;
            existing.expiry       = p.expiry;
            existing.barcode     = p.barcode;
        } else {
            stock.push({
                date: p.purchaseDate,
                name: p.name,
                buy: p.buy,
                sell: p.sell,
                qtyOriginal: p.qty,
                qtyLeft: p.qty,
                expiry: p.expiry,
                barcode: p.barcode
            });
        }
    });

    localStorage.setItem("stock", JSON.stringify(stock));
    alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†");
    purchases=[];
    render();
}
</script>
</body>
</html>
