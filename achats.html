<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“¦ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</title>
<meta name="theme-color" content="#28a745">
<link rel="manifest" href="manifest.json">

<style>
body{margin:0;font-family:'Comic Sans MS', Arial;direction:rtl;background:#050b18;color:white;}
header{background:#28a745;padding:20px;text-align:center;font-size:32px;font-weight:bold;box-shadow:0 0 25px #28a745;}
.container{padding:20px;max-width:1100px;margin:auto;display:flex;flex-direction:column;gap:20px;}
.card{background:#0f1b2e;border-radius:20px;padding:20px;box-shadow:0 0 15px rgba(0,255,150,.4), inset 0 0 10px rgba(0,255,150,.2);}
.flex{display:flex;gap:20px;flex-wrap:wrap;}
input{width:100%;padding:14px;font-size:20px;border-radius:10px;border:none;margin-bottom:10px;}
.btn{padding:14px;font-size:20px;border:none;border-radius:12px;cursor:pointer;width:100%;margin-top:10px;}
.scan{background:#ffc107;color:black;}
.add{background:#17a2b8;}
.save{background:#28a745;}
.delete{background:#dc3545;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;}
video{width:100%;max-height:260px;border-radius:15px;display:none;box-shadow:0 0 20px #00ffff;}
table{width:100%;border-collapse:collapse;margin-top:15px;background:#0b1628;font-size:18px;}
th,td{border:1px solid #333;padding:10px;text-align:center;}
th{background:#28a745;}
td input{width:70px;font-size:16px;}
.search{position:relative;}
.suggestions{position:absolute;background:white;width:100%;border-radius:10px;z-index:1000;max-height:200px;overflow-y:auto;color:black;}
.suggestions div{padding:12px;cursor:pointer;}
.suggestions div:hover{background:#eee;}
</style>
</head>
<body>

<header>ğŸ“¦ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</header>

<div class="container">
<div class="flex">
    <div class="card">
        <button class="btn scan" onclick="toggleScanner()">ğŸ“· ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
        <button class="btn scan" onclick="toggleCamera()">ğŸ”„ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
        <video id="camera"></video>

        <input id="barcode" placeholder="ğŸ“¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯">
        <div class="search">
            <input id="productSearch" placeholder="ğŸ§¾ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
            <div id="suggestions" class="suggestions"></div>
        </div>
        <input id="price" placeholder="ğŸ’µ Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">
        <input id="qty" type="number" placeholder="ğŸ“¦ Ø§Ù„ÙƒÙ…ÙŠØ©">
        <input id="date" type="date" placeholder="ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±Ø§Ø¡">

        <button class="btn add" onclick="addPurchase()">â• Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</button>
    </div>
</div>

<div class="card">
<table>
<thead>
<tr>
<th>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</th>
<th>Ø§Ù„Ù…Ù†ØªØ¬</th>
<th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
<th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
<th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±Ø§Ø¡</th>
<th>Ø­Ø°Ù</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
<button class="btn save" onclick="savePurchases()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</button>
</div>
</div>

<audio id="beep">
<source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAIlYAAESsAAACABAAZGF0YRAAAAAA//8AAP//AAD//wAA">
</audio>

<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script>
let stock = JSON.parse(localStorage.getItem("stock")) || [];
let purchases = [];
const tbody = document.getElementById("tbody");
const beep = document.getElementById("beep");
let video = document.getElementById("camera");

let scanning = false;
let useFrontCamera = false;

/* ===================== Ù‚Ø§Ø±Ø¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ===================== */
function toggleScanner(){
    if(scanning){
        stopScanner();
    } else {
        startScanner();
    }
}

function startScanner(){
    scanning = true;
    video.style.display="block";
    Quagga.init({
        inputStream: { type:"LiveStream", target:video, constraints:{facingMode:useFrontCamera?"user":"environment"} },
        decoder: { readers:["code_128_reader","ean_reader","ean_13_reader","upc_reader","code_39_reader","code_93_reader"] },
        locate:true
    }, function(err){ if(err){ console.error(err); scanning=false; return; } Quagga.start(); });
    Quagga.onDetected(onDetected);
}

function stopScanner(){
    Quagga.stop();
    video.style.display="none";
    scanning=false;
}

function toggleCamera(){
    useFrontCamera = !useFrontCamera;
    if(scanning){ stopScanner(); startScanner(); }
}

function onDetected(result){
    if(result && result.codeResult && result.codeResult.code){
        let code = result.codeResult.code;
        beep.play();
        document.getElementById("barcode").value = code;

        let p = stock.find(x=>x.barcode === code);
        if(p){
            document.getElementById("productSearch").value = p.name;
            document.getElementById("price").value = p.buy;
        } else {
            document.getElementById("productSearch").value = "";
            document.getElementById("price").value = "";
        }
        stopScanner();
    }
}

/* ================= Ø¥ÙƒÙ…Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ ================= */
const productInput = document.getElementById("productSearch");
const suggestions = document.getElementById("suggestions");
const priceInput = document.getElementById("price");

productInput.addEventListener("input", function(){
    let value = this.value.trim().toLowerCase();
    suggestions.innerHTML = "";
    if(!value) return;
    stock.forEach(p=>{
        if(p.name.toLowerCase().startsWith(value)){
            let div = document.createElement("div");
            div.textContent = p.name + " (Ù…ØªØ¨Ù‚ÙŠ: " + p.qtyLeft + ")";
            div.onclick = ()=>{
                productInput.value = p.name;
                priceInput.value = p.buy;
                suggestions.innerHTML="";
            };
            suggestions.appendChild(div);
        }
    });
});

/* ================= Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ================= */
function addPurchase(){
    let barcode = document.getElementById("barcode").value;
    let name = document.getElementById("productSearch").value;
    let price = Number(document.getElementById("price").value);
    let qty = Number(document.getElementById("qty").value);
    let date = document.getElementById("date").value;

    if(!name || qty<=0 || price<=0 || !date){ alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„"); return; }

    purchases.push({barcode,name,buy:price,qty,date});
    render();
    document.querySelectorAll("#barcode,#productSearch,#price,#qty,#date").forEach(i=>i.value="");
}

/* Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª */
function render(){
    tbody.innerHTML="";
    purchases.forEach((p,i)=>{
        let tr = document.createElement("tr");
        tr.innerHTML = `
<td>${p.barcode}</td>
<td>${p.name}</td>
<td>${p.buy}</td>
<td>${p.qty}</td>
<td>${p.date}</td>
<td><button class="delete" onclick="del(${i})">âŒ</button></td>
        `;
        tbody.appendChild(tr);
    });
}

/* Ø­Ø°Ù Ø¹Ù†ØµØ± */
function del(i){ purchases.splice(i,1); render(); }

/* ================= Ø­ÙØ¸ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ù„Ù…Ø®Ø²ÙˆÙ† ================= */
function savePurchases(){
    if(!purchases.length){ alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙŠØ§Øª"); return; }

    purchases.forEach(p=>{
        let existing = stock.find(x=>x.barcode===p.barcode);
        if(existing){
            existing.qtyOriginal += p.qty;
            existing.qtyLeft += p.qty;
            existing.buy = p.buy;
            existing.date = p.date;
        } else {
            stock.push({...p, qtyOriginal:p.qty, qtyLeft:p.qty});
        }
    });

    localStorage.setItem("stock", JSON.stringify(stock));
    purchases=[];
    render();
    alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†");
}
</script>
</body>
</html>
