<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestion Stock</title>

<!-- ğŸ”¥ Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
*{box-sizing:border-box;}
body{margin:0;font-family:Arial;direction:rtl;background:#0a1f3f;color:white;padding:10px;}
header{background:#28a745;padding:15px;text-align:center;font-size:28px;border-radius:12px;margin-bottom:15px;}
.container{display:grid;grid-template-columns:250px 1fr;gap:15px;}
.images{background:#08152a;border-radius:15px;padding:10px;overflow-y:auto;max-height:80vh;}
.img-item{border:2px solid #00ff99;border-radius:12px;margin-bottom:10px;padding:5px;cursor:pointer;text-align:center;}
.img-item img{width:100%;height:120px;object-fit:contain;background:#fff;border-radius:10px;}
.img-item span{display:block;margin-top:5px;font-size:14px;color:#00ffcc;}
.card{background:#08152a;padding:15px;border-radius:15px;}
input,button,select{width:100%;padding:10px;margin:5px 0;border-radius:10px;border:none;font-size:16px;}
input{background:#000;color:#0ff;border:1px solid #00ff99;}
button{background:#17a2b8;color:white;cursor:pointer;}
button:hover{opacity:.8;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{padding:8px;border-bottom:1px solid #123;text-align:center;}
th{background:#28a745;}
.stockLabel{color:#0f0;font-weight:bold;}
</style>
</head>
<body>

<header>ğŸ›’ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</header>

<div class="container">
<div class="images" id="imageList"></div>

<div class="card">
<h3>Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h3>
<input id="barcode" placeholder="ğŸ“¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯">
<input id="product" placeholder="ğŸ§¾ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
<select id="category">
    <option value="">ğŸ·ï¸ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</option>
    <option value="Ø§Ù„Ø­Ù„ÙˆÙŠØ§Øª">Ø§Ù„Ø­Ù„ÙˆÙŠØ§Øª</option>
    <option value="Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª">Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª</option>
    <option value="Ø§Ù„Ø¹Ø·ÙˆØ± Ø§Ù„Ø±Ø¬Ø§Ù„ÙŠØ©">Ø§Ù„Ø¹Ø·ÙˆØ± Ø§Ù„Ø±Ø¬Ø§Ù„ÙŠØ©</option>
    <option value="Ø§Ù„Ø¹Ø·ÙˆØ± Ø§Ù„Ù†Ø³Ø§Ø¦ÙŠØ©">Ø§Ù„Ø¹Ø·ÙˆØ± Ø§Ù„Ù†Ø³Ø§Ø¦ÙŠØ©</option>
    <option value="CosmÃ©tique">CosmÃ©tique</option>
    <option value="Autres">Autres</option>
</select>
<input id="buy" placeholder="ğŸ’° Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">
<input id="sell" placeholder="ğŸ’µ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
<input id="qty" type="number" placeholder="ğŸ“¦ Ø§Ù„ÙƒÙ…ÙŠØ©">
<input id="date" type="date">
<input id="expiry" type="date">
<label>ğŸ“· ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬</label>
<input type="file" id="imageInput" accept="image/*">
<button onclick="addPurchase()">â• Ø¥Ø¶Ø§ÙØ©</button>

<h3>Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>
<table>
<thead>
<tr>
<th>Ø§Ù„Ù…Ù†ØªØ¬</th>
<th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th>
<th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠØ©</th>
<th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</th>
<th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
<th>ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>
</div>

<script>
/* ğŸ”¥ Firebase config (Ø¨Ø¯Ù‘Ù„ Ø§Ù„Ù‚ÙŠÙ… ÙÙ‚Ø·) */
firebase.initializeApp({
  apiKey: "API_KEY",
  authDomain: "PROJECT.firebaseapp.com",
  databaseURL: "https://PROJECT-default-rtdb.firebaseio.com",
  projectId: "PROJECT",
});
const db = firebase.database();

let stock = [];
const tbody = document.getElementById("tbody");

/* ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù…Ù† Firebase ===== */
db.ref("stock").on("value", snap=>{
    stock = Object.values(snap.val()||{}).map(p=>({...p,id:p.id}));
    renderImages();
});

/* ===== Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± ===== */
function renderImages(){
    const list = document.getElementById("imageList");
    list.innerHTML="";
    stock.forEach((p,i)=>{
        if(!p.image) return;
        let div = document.createElement("div");
        div.className="img-item";
        div.innerHTML=`
            <img src="${p.image}">
            <span>${p.name} ${p.category? '('+p.category+')' : ''}</span>
        `;
        div.onclick = ()=>{ 
            product.value = p.name;
            sell.value = p.sell;
            buy.value = p.buy;
            barcode.value = p.barcode || "";
            category.value = p.category || "";
            qty.value = p.qtyOriginal;
            date.value = p.date || "";
            expiry.value = p.expiry || "";
        };
        list.appendChild(div);
    });
    renderStockTable();
}

/* ===== Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ ===== */
function addPurchase(){
    let imgFile = document.getElementById("imageInput").files[0];
    let reader = new FileReader();

    reader.onload = function(){
        const prod = {
            name: product.value,
            category: category.value || "",
            buy: +buy.value,
            sell: +sell.value,
            qtyOriginal: +qty.value,
            qtyLeft: +qty.value,
            date: date.value,
            expiry: expiry.value,
            barcode: barcode.value,
            image: reader.result
        };

        // Ø­ÙØ¸ ÙÙŠ Firebase
        const newProdRef = firebase.database().ref("stock").push(); // Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙØªØ§Ø­ Ø¬Ø¯ÙŠØ¯
        newProdRef.set(prod, (error)=>{
            if(error){
                alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸ ÙÙŠ Firebase");
            } else {
                clearInputs();
                loadStockFromFirebase(); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù…Ù† Firebase Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                alert("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†");
            }
        });
    }

    if(imgFile) reader.readAsDataURL(imgFile);
    else reader.onload();
}

        };
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬
        let exist = stock.find(x=>x.name===prod.name && x.category===prod.category);
        if(exist){
            exist.qtyOriginal += prod.qtyOriginal;
            exist.qtyLeft += prod.qtyLeft;
            exist.buy = prod.buy;
            exist.sell = prod.sell;
            exist.image = prod.image;
            db.ref("stock/"+exist.id).set(exist);
        } else {
            db.ref("stock/"+id).set(prod);
        }
        clearInputs();
        alert("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†");
    };
    if(imgFile) reader.readAsDataURL(imgFile);
    else reader.onload();
}

/* ===== Ù…Ø³Ø­ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ===== */
function clearInputs(){
    product.value = category.value = buy.value = sell.value = qty.value = date.value = expiry.value = barcode.value = "";
    imageInput.value = "";
}

/* ===== Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ===== */
function renderStockTable(){
    tbody.innerHTML="";
    stock.forEach((p,i)=>{
        let tr = document.createElement("tr");
        tr.innerHTML=`
            <td>${p.name}</td>
            <td>${p.category}</td>
            <td>${p.qtyOriginal}</td>
            <td class="stockLabel">${p.qtyLeft}</td>
            <td>${p.sell}</td>
            <td>
                <button onclick="editItem(${i})">âœï¸</button>
                <button onclick="deleteItem(${i})">ğŸ—‘ï¸</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

/* ===== ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬ ===== */
function editItem(i){
    const p = stock[i];
    let newName = prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:", p.name) || p.name;
    let newCat = prompt("Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:", p.category) || p.category;
    let newBuy = prompt("Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡:", p.buy) || p.buy;
    let newSell = prompt("Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹:", p.sell) || p.sell;
    let newQty = prompt("Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠØ©:", p.qtyOriginal) || p.qtyOriginal;
    p.name = newName;
    p.category = newCat;
    p.buy = +newBuy;
    p.sell = +newSell;
    p.qtyOriginal = +newQty;
    p.qtyLeft = Math.min(p.qtyLeft, +newQty);
    db.ref("stock/"+p.id).set(p);
}

/* ===== Ø­Ø°Ù Ù…Ù†ØªØ¬ ===== */
function deleteItem(i){
    if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ")){
        const p = stock[i];
        db.ref("stock/"+p.id).remove();
    }
}
</script>

</body>
</html>

